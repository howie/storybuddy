name: CI with Agent Auto-Fix

on:
  push:
    branches: [main, develop, 'claude/**']
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.11'
  FLUTTER_VERSION: '3.24.0'

jobs:
  # ==============================================================================
  # Python Backend Checks
  # ==============================================================================
  python-check:
    name: Python Lint & Test
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outcome }}
      error_type: ${{ steps.classify.outputs.error_type }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Ruff Linting
        id: ruff_lint
        continue-on-error: true
        run: ruff check .

      - name: Run Ruff Format Check
        id: ruff_format
        continue-on-error: true
        run: ruff format --check .

      - name: Run MyPy Type Checking
        id: mypy
        continue-on-error: true
        run: mypy src/

      - name: Run Pytest
        id: pytest
        continue-on-error: true
        run: pytest tests/ -v --cov=src --cov-report=xml

      - name: Classify Error Type
        id: classify
        if: |
          steps.ruff_lint.outcome == 'failure' ||
          steps.ruff_format.outcome == 'failure' ||
          steps.mypy.outcome == 'failure' ||
          steps.pytest.outcome == 'failure'
        run: |
          if [[ "${{ steps.ruff_format.outcome }}" == "failure" ]]; then
            echo "error_type=formatting" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.mypy.outcome }}" == "failure" ]]; then
            echo "error_type=complex" >> $GITHUB_OUTPUT
          else
            echo "error_type=standard" >> $GITHUB_OUTPUT
          fi

      - name: Check Overall Status
        id: check
        run: |
          if [[ "${{ steps.ruff_lint.outcome }}" == "failure" ]] || \
             [[ "${{ steps.ruff_format.outcome }}" == "failure" ]] || \
             [[ "${{ steps.mypy.outcome }}" == "failure" ]] || \
             [[ "${{ steps.pytest.outcome }}" == "failure" ]]; then
            echo "Python checks failed"
            exit 1
          fi
          echo "All Python checks passed"

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage
          path: coverage.xml
          retention-days: 30

  # ==============================================================================
  # Flutter Mobile App Checks
  # ==============================================================================
  flutter-check:
    name: Flutter Analyze & Test
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outcome }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get Flutter Dependencies
        working-directory: ./mobile
        run: flutter pub get

      - name: Verify Flutter Format
        id: format
        continue-on-error: true
        working-directory: ./mobile
        run: dart format --set-exit-if-changed .

      - name: Run Flutter Analyze
        id: analyze
        continue-on-error: true
        working-directory: ./mobile
        run: flutter analyze

      - name: Run Flutter Tests
        id: test
        continue-on-error: true
        working-directory: ./mobile
        run: flutter test --coverage

      - name: Check Overall Status
        id: check
        run: |
          if [[ "${{ steps.format.outcome }}" == "failure" ]] || \
             [[ "${{ steps.analyze.outcome }}" == "failure" ]] || \
             [[ "${{ steps.test.outcome }}" == "failure" ]]; then
            echo "Flutter checks failed"
            exit 1
          fi
          echo "All Flutter checks passed"

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flutter-coverage
          path: mobile/coverage/lcov.info
          retention-days: 30

  # ==============================================================================
  # Agent Auto-Fix (Runs on Python Check Failure)
  # ==============================================================================
  python-auto-fix:
    name: ü§ñ Agent Auto-Fix (Python)
    runs-on: ubuntu-latest
    needs: [python-check]
    if: always() && needs.python-check.result == 'failure'
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout Code with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Determine Model
        id: model
        run: |
          ERROR_TYPE="${{ needs.python-check.outputs.error_type }}"
          if [[ "$ERROR_TYPE" == "formatting" ]]; then
            echo "model=haiku" >> $GITHUB_OUTPUT
            echo "max_iterations=3" >> $GITHUB_OUTPUT
          elif [[ "$ERROR_TYPE" == "complex" ]]; then
            echo "model=sonnet" >> $GITHUB_OUTPUT
            echo "max_iterations=5" >> $GITHUB_OUTPUT
          else
            echo "model=sonnet" >> $GITHUB_OUTPUT
            echo "max_iterations=5" >> $GITHUB_OUTPUT
          fi

      - name: Run Agent Auto-Fix
        id: agent_fix
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          max_attempts=3
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "üîÑ Agent Auto-Fix Attempt $attempt of $max_attempts"

            # Run Claude Agent
            if echo "The Python CI checks failed. Please fix all issues:
                1. Run 'ruff check --fix .' to auto-fix linting issues
                2. Run 'ruff format .' to fix formatting
                3. Fix any mypy type errors in src/
                4. Fix failing pytest tests
                5. Only modify necessary code - do not refactor or add features
                6. Ensure all changes are minimal and focused

                After fixes, verify by running the checks again." | claude --dangerously-skip-user-approval; then
              echo "‚úÖ Agent succeeded on attempt $attempt"
              echo "success=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            attempt=$((attempt + 1))
            if [ $attempt -le $max_attempts ]; then
              echo "‚è≥ Waiting 10 seconds before retry..."
              sleep 10
            fi
          done

          echo "‚ùå Agent failed after $max_attempts attempts"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1

      - name: Re-run Checks to Verify Fixes
        if: steps.agent_fix.outputs.success == 'true'
        run: |
          echo "üîç Verifying fixes..."
          ruff check .
          ruff format --check .
          mypy src/
          pytest tests/ -v

      - name: Commit and Push Fixes
        if: steps.agent_fix.outputs.success == 'true'
        run: |
          git config user.name "Claude CI Agent"
          git config user.email "claude-agent@ci.bot"

          # Check if there are changes
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "fix(ci): auto-fix Python lint and test errors

            ü§ñ Automated fixes by Claude Agent
            - Fixed linting issues (ruff)
            - Fixed formatting (ruff format)
            - Fixed type errors (mypy)
            - Fixed failing tests (pytest)

            Error type: ${{ needs.python-check.outputs.error_type }}
            Model used: ${{ steps.model.outputs.model }}"

            # Push to the same branch
            BRANCH="${{ github.head_ref || github.ref_name }}"
            git push origin HEAD:$BRANCH
            echo "‚úÖ Fixes committed and pushed to $BRANCH"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi

      - name: Create Issue on Failure
        if: steps.agent_fix.outputs.success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ü§ñ CI Auto-Fix Failed: Python Checks',
              body: `## Agent Auto-Fix Failed

              The Claude Agent was unable to automatically fix the Python CI errors after 3 attempts.

              **Branch:** \`${{ github.head_ref || github.ref_name }}\`
              **Commit:** ${{ github.sha }}
              **Error Type:** ${{ needs.python-check.outputs.error_type }}
              **Model Used:** ${{ steps.model.outputs.model }}

              ### Manual Intervention Required

              Please review the CI logs and fix the issues manually:
              - Linting errors (ruff)
              - Formatting issues (ruff format)
              - Type errors (mypy)
              - Test failures (pytest)

              **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              labels: ['ci-failure', 'needs-attention', 'python']
            });

      - name: Upload Agent Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-agent-logs
          path: |
            *.log
            agent-*.txt
          retention-days: 30

  # ==============================================================================
  # Agent Auto-Fix (Runs on Flutter Check Failure)
  # ==============================================================================
  flutter-auto-fix:
    name: ü§ñ Agent Auto-Fix (Flutter)
    runs-on: ubuntu-latest
    needs: [flutter-check]
    if: always() && needs.flutter-check.result == 'failure'
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout Code with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get Flutter Dependencies
        working-directory: ./mobile
        run: flutter pub get

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Agent Auto-Fix
        id: agent_fix
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "The Flutter CI checks failed. Please fix all issues:
              1. Run 'dart format .' in mobile/ directory to fix formatting
              2. Fix issues reported by 'flutter analyze'
              3. Fix failing Flutter tests
              4. Only modify necessary code in mobile/ directory

              After fixes, verify by running the checks again." | claude --dangerously-skip-user-approval

      - name: Re-run Checks to Verify Fixes
        if: steps.agent_fix.outcome == 'success'
        working-directory: ./mobile
        run: |
          echo "üîç Verifying fixes..."
          dart format --set-exit-if-changed .
          flutter analyze
          flutter test

      - name: Commit and Push Fixes
        if: steps.agent_fix.outcome == 'success'
        run: |
          git config user.name "Claude CI Agent"
          git config user.email "claude-agent@ci.bot"

          if [[ -n $(git status --porcelain) ]]; then
            git add mobile/
            git commit -m "fix(mobile): auto-fix Flutter analyze and test errors

            ü§ñ Automated fixes by Claude Agent
            - Fixed formatting (dart format)
            - Fixed analyzer issues (flutter analyze)
            - Fixed failing tests

            Model used: sonnet"

            BRANCH="${{ github.head_ref || github.ref_name }}"
            git push origin HEAD:$BRANCH
            echo "‚úÖ Fixes committed and pushed to $BRANCH"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi

      - name: Create Issue on Failure
        if: steps.agent_fix.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ü§ñ CI Auto-Fix Failed: Flutter Checks',
              body: `## Agent Auto-Fix Failed

              The Claude Agent was unable to automatically fix the Flutter CI errors.

              **Branch:** \`${{ github.head_ref || github.ref_name }}\`
              **Commit:** ${{ github.sha }}

              ### Manual Intervention Required

              Please review the CI logs and fix the issues manually:
              - Formatting issues (dart format)
              - Analyzer warnings/errors (flutter analyze)
              - Test failures

              **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              labels: ['ci-failure', 'needs-attention', 'flutter']
            });

  # ==============================================================================
  # Code Review Agent (PR Only)
  # ==============================================================================
  code-review:
    name: üîç AI Code Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get Changed Files
        id: changed_files
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ' ')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

      - name: Run Code Review Agent
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Review the following changed files for a pull request:

              Changed files: ${{ steps.changed_files.outputs.files }}

              Please provide a comprehensive code review covering:
              1. **Code Quality**: Readability, maintainability, best practices
              2. **Security**: Potential vulnerabilities (SQL injection, XSS, etc.)
              3. **Performance**: Inefficient algorithms, memory leaks, N+1 queries
              4. **Testing**: Missing test coverage, edge cases
              5. **Architecture**: Design patterns, separation of concerns
              6. **Python-specific**: Type hints, PEP 8 compliance (for .py files)
              7. **Flutter-specific**: Widget structure, state management (for .dart files)

              Format the review as markdown with:
              - Summary section
              - Issues found (categorized by severity: Critical, High, Medium, Low)
              - Suggestions for improvement
              - Positive observations

              Be constructive and specific.

              Save your review to a file called review-report.md" | claude --dangerously-skip-user-approval || echo "Code review skipped - agent unavailable" > review-report.md

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let review = '';

            try {
              review = fs.readFileSync('review-report.md', 'utf8');
            } catch (error) {
              review = '‚ö†Ô∏è Unable to generate review report. Please check the agent logs.';
            }

            const comment = `## ü§ñ Claude Agent Code Review

            ${review}

            ---
            <sub>Generated by Claude Agent ‚Ä¢ [View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})</sub>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload Review Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-report
          path: review-report.md
          retention-days: 30

  # ==============================================================================
  # Integration Tests (Runs on Success)
  # ==============================================================================
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [python-check, flutter-check]
    if: |
      success() &&
      needs.python-check.result == 'success' &&
      needs.flutter-check.result == 'success'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Get Flutter Dependencies
        working-directory: ./mobile
        run: flutter pub get

      - name: Run Python Integration Tests
        run: |
          echo "üß™ Running Python integration tests..."
          # Add integration test commands here when available
          # pytest tests/integration/ -v

      - name: Run Flutter Integration Tests
        working-directory: ./mobile
        run: |
          echo "üß™ Running Flutter integration tests..."
          # flutter test integration_test/
          # Note: May require emulator or different runner for full E2E

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            test-results/
            mobile/test-results/
          retention-days: 30

  # ==============================================================================
  # Status Check Summary
  # ==============================================================================
  ci-status:
    name: ‚úÖ CI Status Summary
    runs-on: ubuntu-latest
    needs: [python-check, flutter-check]
    if: always()

    steps:
      - name: Check Status
        run: |
          echo "## CI Results Summary"
          echo "Python Check: ${{ needs.python-check.result }}"
          echo "Flutter Check: ${{ needs.flutter-check.result }}"

          if [[ "${{ needs.python-check.result }}" == "success" ]] && \
             [[ "${{ needs.flutter-check.result }}" == "success" ]]; then
            echo "‚úÖ All checks passed!"
            exit 0
          else
            echo "‚ùå Some checks failed. Agent auto-fix may be running."
            # Don't fail this job - let auto-fix attempt to resolve
            exit 0
          fi
