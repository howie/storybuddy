#!/bin/bash
# Pre-push hook example for StoryBuddy
# This hook runs checks before pushing to remote
#
# To install:
#   cp .github/hooks/pre-push.example .git/hooks/pre-push
#   chmod +x .git/hooks/pre-push

echo "üîç Running pre-push checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get the current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)

# Prevent direct push to main/master
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
    echo -e "${RED}‚ùå Direct push to $current_branch is not allowed!${NC}"
    echo -e "${YELLOW}Please create a pull request instead.${NC}"
    exit 1
fi

# ==============================================================================
# 1. Check for uncommitted changes
# ==============================================================================
if ! git diff-index --quiet HEAD --; then
    echo -e "${YELLOW}‚ö† You have uncommitted changes${NC}"
    exit 1
fi

# ==============================================================================
# 2. Run Python checks (if Python files changed)
# ==============================================================================
if git diff --name-only origin/$current_branch...HEAD | grep -q "\.py$"; then
    echo "üêç Running Python checks..."

    # Activate venv if it exists
    if [ -d "venv" ]; then
        source venv/bin/activate 2>/dev/null || . venv/bin/activate
    fi

    # Run ruff
    if ! ruff check .; then
        echo -e "${RED}‚ùå Ruff linting failed${NC}"
        echo -e "${YELLOW}Fix with: ruff check --fix .${NC}"
        exit 1
    fi

    # Run mypy
    if ! mypy src/; then
        echo -e "${RED}‚ùå MyPy type checking failed${NC}"
        exit 1
    fi

    # Run tests
    if ! pytest tests/ --tb=short; then
        echo -e "${RED}‚ùå Tests failed${NC}"
        exit 1
    fi

    echo -e "${GREEN}‚úì Python checks passed${NC}"
fi

# ==============================================================================
# 3. Run Flutter checks (if Dart files changed)
# ==============================================================================
if git diff --name-only origin/$current_branch...HEAD | grep -q "\.dart$"; then
    echo "üì± Running Flutter checks..."

    cd mobile || exit 1

    # Run flutter analyze
    if ! flutter analyze; then
        echo -e "${RED}‚ùå Flutter analyze failed${NC}"
        cd ..
        exit 1
    fi

    # Run flutter tests
    if ! flutter test; then
        echo -e "${RED}‚ùå Flutter tests failed${NC}"
        cd ..
        exit 1
    fi

    cd ..
    echo -e "${GREEN}‚úì Flutter checks passed${NC}"
fi

# ==============================================================================
# 4. Check for secrets
# ==============================================================================
if command -v detect-secrets >/dev/null 2>&1; then
    echo "üîê Checking for secrets..."
    if ! detect-secrets scan --baseline .secrets.baseline $(git diff --name-only origin/$current_branch...HEAD) >/dev/null 2>&1; then
        echo -e "${RED}‚ùå Potential secrets detected!${NC}"
        echo -e "${YELLOW}Review the files and update .secrets.baseline if needed${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úì No secrets detected${NC}"
fi

# ==============================================================================
# 5. All checks passed
# ==============================================================================
echo -e "${GREEN}‚úÖ All pre-push checks passed! Pushing...${NC}"
exit 0
